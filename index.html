<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>CyberSearch ‚Äì GitHub & Web Search</title>
<meta name="description" content="CyberSearch: a search engine for GitHub projects and external sites.">
<style>
:root {
  --bg: #0b0f14; --text: #e6edf3; --card: #161b22; --hover: #222c36; --link: #58a6ff; --muted:#aaa;
}
body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
header { text-align: center; padding: 40px; position: relative; }
.autocomplete { position: relative; display: inline-block; width: 60%; max-width: 900px; }
#searchRow { display: flex; gap: 8px; align-items: center; }
#searchBox {
  flex: 1; padding: 14px 40px 14px 14px; font-size: 18px; border-radius: 10px; border: none; background: var(--card); color: var(--text);
}
.btn {
  padding: 12px 16px; border-radius: 10px; border: none; cursor: pointer; background: var(--card); color: var(--text);
}
.btn:hover { background: var(--hover); }
.clear-btn {
  position: absolute; right: 122px; /* leave space for button */ top: 50%; transform: translateY(-50%);
  cursor: pointer; font-size: 18px; color: var(--muted); display: none;
}
.clear-btn:hover { color: var(--text); }
.results { max-width: 900px; margin: 20px auto; padding: 0 16px; }
.card { background: var(--card); padding: 20px; margin: 15px 0; border-radius: 12px; }
.title { font-size: 20px; color: var(--link); text-decoration: none; }
.suggestions, .recent-searches {
  position: absolute; background: var(--card); border: 1px solid #333; border-radius: 6px;
  width: 100%; max-height: 220px; overflow-y: auto; z-index: 99; margin-top: 6px;
}
.suggestion-item, .recent-item { padding: 8px; cursor: pointer; }
.suggestion-item:hover, .recent-item:hover, .active { background: var(--hover); }
.recent-label { font-size: 12px; padding: 4px 8px; color: var(--muted); border-bottom: 1px solid #333; }
#err { display:none; background:#642; color:#fff; padding:8px 12px; border-radius:8px; max-width:900px; margin:0 auto 10px; }
</style>
<script src="https://unpkg.com/lunr/lunr.js"></script>
</head>
<body>
<header>
  <h1>‚ö° CyberSearch</h1>
  <div id="err"></div>
  <div class="autocomplete">
    <div id="searchRow">
      <input type="text" id="searchBox" placeholder="Search projects and sites...">
      <span id="clearBtn" class="clear-btn">‚ùå</span>
      <button id="searchBtn" class="btn">Search</button>
      <button id="toggleTheme" class="btn">üåô Dark</button>
    </div>
    <div id="suggestions" class="suggestions"></div>
    <div id="recentSearches" class="recent-searches" style="display:none;"></div>
  </div>
</header>
<div class="results" id="results"></div>
<script>
let data = [], idx;
let recent = [];
let activeIndex = -1;
let currentList = [];
const err = (msg) => { const e = document.getElementById('err'); e.textContent = msg; e.style.display='block'; };

async function loadJSON(path) {
  const res = await fetch(path);
  if (!res.ok) throw new Error(path + " ‚Üí HTTP " + res.status);
  return res.json();
}

async function init() {
  try {
    const batches = await Promise.allSettled([
      loadJSON("projects1.json"),
      loadJSON("external1.json")
    ]);
    batches.forEach(b => {
      if (b.status === "fulfilled" && Array.isArray(b.value)) data = data.concat(b.value);
      if (b.status === "rejected") err("Could not load: " + b.reason.message + ". Are you serving over http://localhost and is the file present?");
    });
    if (data.length === 0) err("No data loaded. Make sure projects1.json / external1.json exist and you're serving this folder (not opening as a file).");
  } catch (e) {
    err("Data load error: " + e.message);
  }

  if (typeof lunr === "undefined") {
    err("Lunr.js failed to load. Check your internet connection (CDN).");
    return;
  }

  idx = lunr(function () {
    this.ref('id');
    this.field('title'); this.field('description'); this.field('language');
    data.forEach(d => this.add(d));
  });

  // Optionally render some default results (top N) so page isn't empty
  render(data.slice(0, 5).map(d => ({ ref: d.id })));
}

function render(results) {
  const container = document.getElementById("results");
  container.innerHTML = results.map(r => {
    const doc = data.find(d => d.id === (r.ref || r));
    if (!doc) return "";
    return `<div class="card">
      <a href="${doc.page}" class="title">${doc.title}</a>
      <p>${doc.description}</p>
      <p>‚≠ê ${doc.stars || ""} ${doc.language || ""}</p>
    </div>`;
  }).join("");
}

function runSearch(q) {
  if (!idx || !q) { render([]); return; }
  if (!recent.includes(q)) {
    recent.push(q); if (recent.length > 10) recent.shift();
  }
  showRecent();
  const results = idx.search(q);
  render(results);
}

function highlightItem(index) {
  clearHighlights();
  if (currentList.length > 0 && index >= 0 && index < currentList.length) {
    currentList[index].classList.add("active");
  }
}
function clearHighlights() { currentList.forEach(item => item.classList.remove("active")); }

function showSuggestions(query) {
  const box = document.getElementById("searchBox");
  const suggestionsDiv = document.getElementById("suggestions");
  suggestionsDiv.innerHTML = ""; currentList = [];
  if (!query) return;

  const results = idx ? idx.search(query + "*").slice(0, 8) : [];
  results.forEach(r => {
    const doc = data.find(d => d.id === r.ref);
    if (doc) {
      const item = document.createElement("div");
      item.className = "suggestion-item";
      item.innerText = doc.title;
      item.onclick = () => {
        box.value = doc.title;
        suggestionsDiv.innerHTML = "";
        runSearch(doc.title);
      };
      suggestionsDiv.appendChild(item);
      currentList.push(item);
    }
  });
}

function showRecent() {
  const recentDiv = document.getElementById("recentSearches");
  recentDiv.innerHTML = ""; currentList = [];
  if (recent.length === 0) { recentDiv.style.display = "none"; return; }
  recentDiv.style.display = "block";
  const label = document.createElement("div");
  label.className = "recent-label"; label.innerText = "Recent Searches";
  recentDiv.appendChild(label);

  recent.slice(-5).reverse().forEach(q => {
    const item = document.createElement("div");
    item.className = "recent-item";
    item.innerText = q;
    item.onclick = () => {
      document.getElementById("searchBox").value = q;
      runSearch(q);
      recentDiv.style.display = "none";
    };
    recentDiv.appendChild(item);
    currentList.push(item);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  init();
  const box = document.getElementById("searchBox");
  const clearBtn = document.getElementById("clearBtn");
  const searchBtn = document.getElementById("searchBtn");
  const toggleBtn = document.getElementById("toggleTheme");

  // Typing search + suggestions
  box.addEventListener("input", e => {
    const val = e.target.value;
    activeIndex = -1;
    showSuggestions(val);
    clearBtn.style.display = val ? "block" : "none";
  });

  // Enter to search
  box.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      runSearch(box.value.trim());
    }
    if (["ArrowDown","ArrowUp","Escape"].includes(e.key)) {
      const hasSuggestions = document.getElementById("suggestions").children.length > 0;
      const list = hasSuggestions ? document.getElementById("suggestions") : document.getElementById("recentSearches");
      if (list && currentList.length > 0) {
        if (e.key === "ArrowDown") { activeIndex = (activeIndex + 1) % currentList.length; highlightItem(activeIndex); e.preventDefault(); }
        if (e.key === "ArrowUp")   { activeIndex = (activeIndex - 1 + currentList.length) % currentList.length; highlightItem(activeIndex); e.preventDefault(); }
        if (e.key === "Escape")    { document.getElementById("suggestions").innerHTML = ""; document.getElementById("recentSearches").style.display = "none"; activeIndex = -1; }
      }
    }
  });

  // Click search button
  searchBtn.addEventListener("click", () => runSearch(box.value.trim()));

  // Clear button
  clearBtn.addEventListener("click", () => {
    box.value = ""; document.getElementById("results").innerHTML = "";
    document.getElementById("suggestions").innerHTML = "";
    document.getElementById("recentSearches").style.display = "block";
    clearBtn.style.display = "none"; activeIndex = -1; showRecent(); box.focus();
  });

  // Show recent on focus
  box.addEventListener("focus", () => { if (!box.value) { activeIndex = -1; showRecent(); } });

  // Dark/Light toggle
  toggleBtn.addEventListener("click", () => {
    document.body.classList.toggle("light-mode");
    toggleBtn.textContent = document.body.classList.contains("light-mode") ? "üåû Light" : "üåô Dark";
  });
});
</script>
</body>
</html>
